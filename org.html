<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Topics & Notifications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background: #f5f6fa;
    }

    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .nav-tabs .nav-link.active {
      font-weight: 600;
      background: #fff !important;
      border-bottom: 3px solid #0d6efd !important;
    }
  </style>
</head>

<body>
  <main class="container py-5">

    <!-- Login Section -->
    <div id="loginCard" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card p-4">
          <div class="card-body">
            <h4 class="text-center mb-3">üîê Admin Login</h4>
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" id="username" class="form-control" placeholder="Enter username">
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" id="password" class="form-control" placeholder="Enter password">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Panel Section -->
    <div id="adminPanel" class="d-none">
      <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button">
            üìÇ Topics
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="notify-tab" data-bs-toggle="tab" data-bs-target="#notify" type="button">
            üì¢ Notifications
          </button>
        </li>
      </ul>

      <div class="tab-content" id="mainTabsContent">

        <!-- Topics Tab -->
        <div class="tab-pane fade show active" id="topics" role="tabpanel">
          <div class="row">
            <div class="col-md-5">
              <div class="card mb-4">
                <div class="card-header">‚ûï Create Topic</div>
                <div class="card-body">
                  <input type="text" id="topicName" class="form-control mb-3" placeholder="Topic Name">
                  <textarea id="description" class="form-control mb-3" rows="3" placeholder="Description"></textarea>
                  <button class="btn btn-primary w-100" onclick="createTopic()">Create</button>
                </div>
              </div>
            </div>
            <div class="col-md-7">
              <div class="card">
                <div class="card-header">üìã Topics List</div>
                <div class="card-body">
                  <ul id="topicsList" class="list-group"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-pane fade" id="notify" role="tabpanel">
          <div class="row">
            <div class="col-md-5">
              <div class="card mb-4">
                <div class="card-header">‚úâÔ∏è Send Notification</div>
                <div class="card-body">
                  <select id="sendTopic" class="form-select mb-3"></select>
                  <input type="text" id="title" class="form-control mb-3" placeholder="Title">
                  <textarea id="body" class="form-control mb-3" rows="3" placeholder="Message Body"></textarea>
                  <button id="sendBtn" class="btn btn-success w-100" onclick="sendNotification()">Send</button>
                </div>
              </div>
            </div>
            <div class="col-md-7">
              <div class="card">
                <div class="card-header">üìë Notification List</div>
                <div class="card-body">
                  <ul id="notificationsList" class="list-group"></ul>
                  <div id="noNotifications" class="text-muted mt-3 text-center d-none">
                    No notifications found.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script>
    const apiBase = "https://2d6zjhwx-9000.inc1.devtunnels.ms";

    function showAdminPanel() {
      document.getElementById("loginCard").classList.add("d-none");
      document.getElementById("adminPanel").classList.remove("d-none");
      loadTopics();
    }

    // ---------- LOGIN ----------
    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();

      if (user === "admin" && pass === "1234") {
        sessionStorage.setItem("adminLoggedIn", "true");
        showAdminPanel();
      } else {
        alert("‚ùå Invalid credentials!");
      }
    }

    // ---------- TOPICS ----------
    async function createTopic() {
      const topic = document.getElementById("topicName").value;
      const description = document.getElementById("description").value;
      if (!topic || !description) { alert("‚ö†Ô∏è Please fill all fields."); return; }
      try {
        const res = await fetch(`${apiBase}/create-topic`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic, description })
        });
        const data = await res.json();
        alert(data.message);
        document.getElementById("topicName").value = "";
        document.getElementById("description").value = "";
        loadTopics();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadTopics() {
      try {
        const res = await fetch(`${apiBase}/topics`);
        const data = await res.json();
        const list = document.getElementById("topicsList");
        const select = document.getElementById("sendTopic");
        list.innerHTML = "";

        // Replace select dropdown with text input
        select.outerHTML = `<input type="text" id="topicInput" class="form-control mb-3" placeholder="Enter Topic ID">`;

        // Re-attach input listener AFTER replacing
        setTimeout(() => {
          const topicInput = document.getElementById("topicInput");
          topicInput.addEventListener("input", () => loadNotifications());
        }, 100);

        if (data.topics) {
          data.topics.forEach(t => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-start";
            li.innerHTML = `<div><strong>${t.topic}</strong><br><small class="text-muted">${t.description}</small></div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTopic('${t.topic}')">Delete</button>`;
            list.appendChild(li);
          });
          loadNotifications();
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteTopic(topic) {
      if (!confirm(`Delete topic: ${topic}?`)) return;
      try {
        const res = await fetch(`${apiBase}/delete-topic/${topic}`, { method: "DELETE" });
        const data = await res.json();
        alert(data.message);
        loadTopics();
      } catch (err) {
        console.error(err);
      }
    }

    // ---------- NOTIFICATIONS ----------
    async function sendNotification() {
      const topic = document.getElementById("topicInput").value;
      const title = document.getElementById("title").value;
      const body = document.getElementById("body").value;
      if (!topic || !title || !body) { alert("‚ö†Ô∏è Please fill all fields."); return; }

      const btn = document.getElementById("sendBtn");
      btn.disabled = true; btn.textContent = "Sending...";

      try {
        const res = await fetch(`${apiBase}/send-to-topic`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic, title, body })
        });
        const data = await res.json();
        alert(data.message);
        document.getElementById("title").value = "";
        document.getElementById("body").value = "";
        loadNotifications();
      } catch (err) {
        console.error(err);
        alert("‚ùå Failed to send notification.");
      }

      btn.disabled = false; btn.textContent = "Send";
    }

    async function loadNotifications() {
      try {
        const res = await fetch(`${apiBase}/notifications`);
        const data = await res.json();
        const list = document.getElementById("notificationsList");
        list.innerHTML = "";

        if (data.success && data.notifications) {
          const topicInput = document.getElementById("topicInput");
          const selectedTopic = topicInput ? topicInput.value.trim() : "";

          const filtered = selectedTopic
            ? data.notifications.filter(n => n.topic === selectedTopic)
            : data.notifications;

          if (filtered.length > 0) {
            document.getElementById("noNotifications").classList.add("d-none");
            filtered.forEach(n => {
              const li = document.createElement("li");
              li.className = "list-group-item";
              li.innerHTML = `<div><strong>${n.title}</strong><br>${n.body}
                              <div class="mt-1"><small>üìå Topic: ${n.topic}</small><br>
                              <small>üïí ${new Date(n.sent_at).toLocaleString()}</small></div></div>`;
              list.appendChild(li);
            });
          } else {
            document.getElementById("noNotifications").classList.remove("d-none");
          }
        } else {
          document.getElementById("noNotifications").classList.remove("d-none");
        }
      } catch (err) {
        console.error(err);
        document.getElementById("noNotifications").classList.remove("d-none");
      }
    }

    document.getElementById("notify-tab").addEventListener("click", () => loadNotifications());

    // ---------- AUTO LOGIN FOR SESSION ----------
    window.addEventListener("DOMContentLoaded", () => {
      if (sessionStorage.getItem("adminLoggedIn") === "true") {
        showAdminPanel();
      }
    });
  </script>
</body>

</html>
