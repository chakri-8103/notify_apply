<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Student Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
    }

    .card-title {
      color: #00796b;
      font-weight: 600;
    }

    input.form-control {
      border-radius: 50px;
      padding: 10px 20px;
    }

    button.btn {
      border-radius: 50px;
      font-weight: 500;
    }

    #notificationsContainer {
      margin-top: 15px;
      gap: 15px;
      flex-wrap: wrap;
      display: flex;
    }

    .notif-card {
      flex: 1 1 calc(50% - 15px);
      border-radius: 12px;
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #0d6efd;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .notif-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .row-details {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .col-left,
    .col-right {
      flex: 1;
      min-width: 300px;
    }

    ul.list-group li {
      border-radius: 10px;
      margin-bottom: 8px;
      padding: 10px 15px;
      transition: background 0.2s ease;
    }

    ul.list-group li:hover {
      background: #e8f5e9;
    }

    .icon-tabs {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-bottom: 15px;
    }

    .icon-tabs i {
      font-size: 24px;
      cursor: pointer;
      color: #00796b;
      transition: color 0.2s;
      position: relative;
    }

    .icon-tabs i.active {
      color: #004d40;
    }

    .red-dot {
      position: absolute;
      top: 0px;
      right: 0px;
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      border: 1px solid white;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center w-100">
      <div class="col-lg-8 col-md-10">

        <!-- Login -->
        <div class="card shadow p-4" id="loginCard">
          <div class="card-body">
            <h3 class="card-title text-center mb-4">Student Login</h3>
            <div class="mb-3">
              <input type="text" id="studentNo" class="form-control" placeholder="Enter Student No">
            </div>
            <div class="mb-3">
              <input type="password" id="password" class="form-control" placeholder="Enter Password">
            </div>
            <button class="btn btn-primary w-100" id="loginBtn">Login</button>
          </div>
        </div>

        <!-- Dashboard -->
        <div class="card shadow p-4 d-none" id="studentCard">
          <div class="card-body">
            <div class="icon-tabs">
              <i class="fa-solid fa-user active" id="studentIcon"></i>
              <i class="fa-solid fa-bell" id="notifIcon">
                <span id="notifDot" class="red-dot" style="display:none;"></span>
              </i>
            </div>
            <div class="row-details">
              <div class="col-left" id="studentInfo">
                <ul class="list-group" id="studentDetails"></ul>
                <button class="btn btn-secondary mt-3 w-100" id="subscribedBtn" disabled>Subscribed ⏳</button>
              </div>
              <div class="col-right" id="notifContainer" style="display:none;">
                <div id="notificationsContainer"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2KIl4oI-3RHlOfQ4sEqQ_jto1djRjbC8",
      authDomain: "abbhyass-f73ce.firebaseapp.com",
      projectId: "abbhyass-f73ce",
      messagingSenderId: "377862942950",
      appId: "1:377862942950:web:9a5e1cd734c16adfe0cb27"
    };
    firebase.initializeApp(firebaseConfig);

    const messaging = firebase.messaging();
    const db = firebase.firestore();

    const notifIcon = document.getElementById("notifIcon");
    const studentIcon = document.getElementById("studentIcon");
    const notifContainer = document.getElementById("notifContainer");
    const studentInfo = document.getElementById("studentInfo");
    const notifDot = document.getElementById("notifDot");
    let hasNewNotifications = false;

    studentIcon.onclick = () => {
      studentInfo.style.display = "block";
      notifContainer.style.display = "none";
      studentIcon.classList.add("active");
      notifIcon.classList.remove("active");
    };

    notifIcon.onclick = () => {
      studentInfo.style.display = "none";
      notifContainer.style.display = "flex";
      notifIcon.classList.add("active");
      studentIcon.classList.remove("active");
      if (hasNewNotifications) {
        localStorage.setItem("seenNotifications", Date.now());
        notifDot.style.display = "none";
        hasNewNotifications = false;
      }
    };

    function cleanTopic(str) {
      return str?.toString().trim().toLowerCase().replace(/\s+/g, "_");
    }

    function getTopics(student) {
      const topic = cleanTopic(`${student.campus_name}_${student.section_name}`);
      console.log("Subscribed Topic:", topic);
      return [topic];
    }

    async function fetchNotifications(topics) {
      try {
        const res = await fetch("https://2d6zjhwx-9000.inc1.devtunnels.ms/notifications");
        const data = await res.json();
        const all = Array.isArray(data.notifications) ? data.notifications : data;

        const filtered = all.filter(n =>
          topics.some(t => cleanTopic(n.topic) === t)
        );

        const container = document.getElementById("notificationsContainer");
        container.innerHTML = "";

        filtered.sort((a, b) => new Date(b.sent_at) - new Date(a.sent_at));

        filtered.forEach(n => {
          const card = document.createElement("div");
          card.className = "notif-card";
          card.innerHTML = `
            <div class="d-flex align-items-center mb-2">
              ${n.logoUrl ? `<img src="${n.logoUrl}" class="rounded-circle me-2" style="width:30px;height:30px;">` : ""}
              <h6 class="fw-bold text-primary mb-0">${n.title || "Untitled"}</h6>
            </div>
            <p class="mb-2">${n.body || ""}</p>
            ${n.image ? `<img src="${n.image}" class="img-fluid rounded mb-2" style="max-height:150px;">` : ""}
            <small class="text-muted d-block">Topic: ${n.topic}</small>
            <small class="text-secondary">Sent at: ${new Date(n.sent_at).toLocaleString()}</small>
          `;
          container.appendChild(card);
        });

        const lastSeen = parseInt(localStorage.getItem("seenNotifications")) || 0;
        if (filtered.length && lastSeen < Date.now() - 10000) {
          notifDot.style.display = "block";
          hasNewNotifications = true;
        } else {
          notifDot.style.display = "none";
        }
      } catch (err) {
        console.error("Notification error:", err.message);
      }
    }

    document.getElementById("loginBtn").onclick = async () => {
      const studentNo = document.getElementById("studentNo").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!studentNo || !password) return alert("Enter Student No & Password");

      try {
        const res = await fetch("https://2d6zjhwx-5000.inc1.devtunnels.ms/loginStudent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentNo, password })
        });
        const data = await res.json();
        if (!data.status) return alert("Invalid credentials");

        const student = data.result[0];
        sessionStorage.setItem("student", JSON.stringify(student));
        document.getElementById("loginCard").classList.add("d-none");
        document.getElementById("studentCard").classList.remove("d-none");

        populateStudent(student);
        await subscribeUser(student);
      } catch (err) {
        alert("Login Error: " + err.message);
      }
    };

    window.onload = async () => {
      const student = JSON.parse(sessionStorage.getItem("student") || null);
      if (student) {
        loginCard.classList.add("d-none");
        studentCard.classList.remove("d-none");
        populateStudent(student);
        const topics = getTopics(student);
        await fetchNotifications(topics);
        updateSubscribeButton(true);
      }
    };

    function populateStudent(student) {
      const list = document.getElementById("studentDetails");
      list.innerHTML = `
        <li class="list-group-item"><b>Name:</b> ${student.student_name}</li>
        <li class="list-group-item"><b>Father:</b> ${student.father_name}</li>
        <li class="list-group-item"><b>Mobile:</b> ${student.mobile_no}</li>
        <li class="list-group-item"><b>Email:</b> ${student.email}</li>
        <li class="list-group-item"><b>Campus:</b> ${student.campus_name}</li>
        <li class="list-group-item"><b>Course:</b> ${student.course_name}</li>
        <li class="list-group-item"><b>Section:</b> ${student.section_name}</li>
        <li class="list-group-item"><b>Roll No:</b> ${student.roll_no}</li>
      `;
    }

    setInterval(async () => {
      const student = JSON.parse(sessionStorage.getItem("student") || null);
      if (student) await fetchNotifications(getTopics(student));
    }, 5000);

    async function subscribeUser(student) {
      try {
        const ref = db.collection("students").doc(student.student_no);
        const docSnap = await ref.get();
        if (docSnap.exists && docSnap.data().fcm_token) {
          console.log("Already subscribed:", docSnap.data().fcm_token);
          updateSubscribeButton(true);
          return;
        }

        const permission = await Notification.requestPermission();
        if (permission !== "granted") throw new Error("Notification permission denied");

        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log("Service Worker Registered");

        const token = await messaging.getToken({
          vapidKey: 'BLMcf7mfo58pZO10XgmKWmLpl61lLzUE256KAwD175k1lu_n4MWvKcbo2enXpqWdnXWdRKDJ9WJXsZQLAsVVaG4',
          serviceWorkerRegistration: registration
        });

        console.log("FCM Token:", token);
        const topics = getTopics(student);

        await ref.set({
          ...student,
          fcm_token: token,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        await fetch("https://2d6zjhwx-5000.inc1.devtunnels.ms/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, topics, ...student })
        });

        await fetchNotifications(topics);
        updateSubscribeButton(true);
      } catch (err) {
        console.error("Subscription failed:", err.message);
      }
    }

    function updateSubscribeButton(isSubscribed) {
      const btn = document.getElementById("subscribedBtn");
      btn.innerText = isSubscribed ? "Subscribed ✅" : "Subscribed ⏳";
      btn.classList.toggle("btn-success", isSubscribed);
      btn.classList.toggle("btn-secondary", !isSubscribed);
      btn.disabled = isSubscribed;
    }

    // Listen to foreground messages
    messaging.onMessage(payload => {
      console.log("Foreground message:", payload);
      if (payload.notification) {
        new Notification(payload.notification.title, {
          body: payload.notification.body,
          icon: payload.notification.icon || '/icon.png'
        });
      }
    });
  </script>
</body>

</html>
